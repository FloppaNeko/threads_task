# Отчет

__Студент__: Миронов Никита Олегович

__Группа__: БПИ237

__Вариант__: 6

__Задание__ : 
___Задача о читателях и писателях («грязное чтение»).___ Базу
данных разделяют два типа потоков — читатели и писатели. Читатели периодически просматривают случайные записи базы данных
и выводя номер свой номер, индекс записи и ее значение. Писатели изменяют случайные записи на случайное число и также выводят информацию о своем номере, индексе записи, старом значении
и новом значении. Предполагается, что в начале БД находится внепротиворечивом состоянии (все числа отсортированы). Каждая отдельная новая запись переводит БД из одного непротиворечивого состояния в другое (то есть, новая сортировка может поменять индексы записей). Транзакции выполняются в режиме «грязного чтения». То есть, процесс–писатель не может получить доступ к БД только в том случае, если ее уже занял другой процесс-писатель, а процессы-читатели ему не мешают обратиться к БД. Поэтому он может изменять базу данных, когда в ней находятся читатели. Создать многопоточное приложение с потоками-писателями и потоками–читателями. 


## Файлы архива:

* __`main.cpp`__ : основная программа, компилируется и запускается командам
    ```
    g++ main.cpp -o main.exe -lpthread
    .\main.exe
    ```

* __`io.cpp`__ : в этот файл выненсены функции, отвечающие за ввод параметров (из различных источников) и вывод информации о работе тредов

* __`config.txt`__ : пример файла конфигурации

* __`out.txt`__ : пример файла результатов работы программы

## Параметры

### Описание парметров:

* Число тредов-читателей, которые будут созданы при запуске программы (`readers`)

* Число тредов-писателей, которые будут созданы при запуске программы (`writers`)

* Имя файла, в который будут ввыводится результаты работы параллельно с консолью (`output`) (опционально)

* Имя файла конфигурации, в котором будут заданы указанные выше парметры (`config`) (опционально)

### Способы задания парметров

1. ___Через файл конфигурации___

    Парметры должны быть описаны в текстовом файле по одному на каждой строчке в формате `<parameter>=<value>`. Отметим, что любой из параметров может быть пропущен, а их порядок не важен

    _Пример:_ файл `config.txt`
    ```
    readers=3
    writers=2
    output=out.txt
    ```

    Для запуска программы через файл конфигурации нужно указать его как параметер при запуске через консоль в формате `.\main.exe config=<file_name>`, т. е. для приведенного примера компиляция запуск будут осуществялтся командами:
    ```
    g++ main.cpp -o main.exe -lpthread
    .\main.exe config=config.txt
    ```

2. ___Через параметры командной строки___

    Вторым способом является указание параметров напрямую через командную строку при запуске программы в формате `.\main.exe <parameter1>=<value1> <parameter2>=<value2> ...` 
    . Здесь также параметры можно пропускать.

    Компиляция и запуск программы с параметрами из уже приведенного примера будет осуществялтся командами
    ```
    g++ main.cpp -o main.exe -lpthread
    .\main.exe readers=3 writers=2 output=out.txt
    ```

3. ___Ввод парметров через консоль___

    Если какой-то из параметров не был указан ни одним из вышеописанных способов, то программа после запуска попросит пользователя указать его через консоль.

    Для уже приведенног примера это будет выглядеть как:
    ```
    Input the number of reader threads: 3
    Input the number of writer threads: 2
    Input the output file name (print N if file output not reqired): out.txt
    ```

    Отметим, что дублирование вывода на консоль в файл можно отключить, если в ответ на запрос имени файла ввести букву `N`

### Описание алгоритма и работы программы

Программа запускает указанное пользователем количество тредов-читателей и тредов-писателей. Треды выполняются бесконечно, так что завершить программу можно только при помощи `Ctrl`+`C`. После каждой итерации каждый тред "засыпает" на случаное число секунд от 1 до 3. Эта функция необязательна для работы программы и существует только для того, что пользователь успевал следить за процессом исполнения на консоли.

Треды работают с "базой данный", в качестве которой служит отсортированный массив целых чисел `data_array`, изначально инициализированный случайными значениями.

Треды-читатели на каждой итерации выбирают случайную ячейку массива и читают её значение. Так как одновременно может выполнятся сколько угодно тредов-читателей, а треды-писатели и читатели также могут выполнятся одновременно, в тредах-читателях нет блокировок (кроме печати).

Треды-писатели на каждой итерации выбирают случайную ячейку массива и меняют её значение на другое случайное, после чего восстанавливают порядок сортировки в массиве. Хотя треды-читатели могут выполнятся одновременно с писателями, друг с другом треды-писатели одновременно выполнятся не могут, поэтому тут создается мьютекс `access_mutex`. Когда один из тредов-писателей редактирует массив, мьютекс блокирует эту секцию для других писателей.

Еще один мьютекс, который присутствует во всех тредах программы, включая главный, это мьютекс блокировки печати на консоль и в файл `print_mutex`. В тот момент, когда один тред пытается что-то напечатать, другие треды печатать не могут. Это существует для того, чтобы печать разных тредов не смешивалась в одной строке.

___Стоит отметить, что так как треды-писатели и треды-читатели могут работать одновременно, может возникнуть такая ситуация, что тред-читатель прочитает данные в процессе того, как тред-писатель исправляет сортировку в массиве, из-за чего читаемые данные не всегда могут быть непротиворечивыми. Для исправления этой проблемы читатели и писатели не должны работать одновременно и должны друг друга блокировать, но этого в задании не требуется, так что это не было реализованно___

